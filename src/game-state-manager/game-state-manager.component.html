<div class="music-toggle-container">
    <button mat-icon-button (click)="toggleMusic()" [attr.aria-label]="isMusicEnabled ? 'Mute music' : 'Unmute music'">
        <mat-icon>{{isMusicEnabled ? 'volume_up' : 'volume_off'}}</mat-icon>
    </button>
</div>

@if (isGameInitialized()) {
    <div class="location-layout">
        <div class="location-panel">
            <div class="map">
                <img src="assets/images/pyre.gif" alt="Pyre" class="pyre">
            </div>
        </div>

        <div class="card-column">
            <mat-card class="instructions" appearance="outlined">
                Once all players have joined, click the Start Game button on your phone to begin!
            </mat-card>
            <mat-card class="game-session-display">
                <div class="qr-code-section">
                    @if(adventureMap) {
                        <h3>Welcome to {{adventureMap.name}}!</h3>
                    } @else {
                        <h3>Welcome to this shapeless place</h3>
                    }
                    <h3>Scan to Join:</h3>
                    <qr-code [value]="qrCodeUrl" size="200" colorLight=var(--mat-option-selected-state-layer-color)
                    colorDark=var(--mat-sys-on-surface) errorCorrectionLevel="M"></qr-code>
                </div>
            </mat-card>
        </div>
    </div>
}

@if (isGameInPreamblePhase()) {
    <div class="location-layout">
        <div class="location-panel">
            <div class="map">
                <img src="assets/images/pyre.gif" alt="Pyre" class="pyre">
            </div>
        </div>

        <div class="card-column">
            <mat-card class="instructions" appearance="outlined">
                {{getInstructionDisplay()}}
            </mat-card>
            <mat-card class="game-session-display">
                {{getGameSessionDisplay()}}
            </mat-card>
        </div>
    </div>
}

@if (isGameInCollaborativeTextPhase()) {
    <app-collaborative-text 
        [gameCode]="gameCode" 
        [gameState]="gameState"
        [phaseInfo]="collaborativeTextPhaseInfo"
        [gameBoard]="gameBoard"
        (winningSubmissionLoaded)="loadCollaborativeTextPhaseInfo()">
    </app-collaborative-text>
    
    @if (isGameInCollaborativeTextWritingPhase()) {
        <app-timer 
            [duration]="getTimerDuration()" 
            [label]="'Collaborative Writing'"
            [autoStart]="false"
            [manualStart]="activePlayerSession.startTimer"
            (timerComplete)="onTimerComplete()">
        </app-timer>
    }
}

@if (isGameInLocationCreationPhase()) {
    <div class="location-layout">
        <div class="location-panel">
            <div class="map">
                <img src="assets/images/pyre.gif" alt="Pyre" class="pyre">
            </div>
        </div>

        <div class="card-column">
            <mat-card class="instructions" appearance="outlined">
                Now is the time to flesh out our world. Look to your device to define an important location in our new world.
            </mat-card>
            <mat-card class="game-session-display">
                {{gameSessionDisplay.mapDescription}}
            </mat-card>
        </div>
    </div>
    
    <app-timer 
        [duration]="getTimerDuration()" 
        [label]="'Location Creation'"
        [autoStart]="false"
        [manualStart]="activePlayerSession.startTimer"
        (timerComplete)="onTimerComplete()">
    </app-timer>
}

@if (isGameInLocationSelectPhase()) {
    <div class="location-layout">
        <div class="location-panel">
          <location [gameCode]="gameCode"></location>
        </div>
      
        <div class="card-column">
          <mat-card class="instructions" appearance="outlined">
            Choose how you will spend your time from your phone. Once you select where you will go someone else will determine what happens to you there.
          </mat-card>
      
          <mat-card class="game-session-display">
            {{ gameSessionDisplay.goalDescription }}
          </mat-card>
        </div>
    </div>
}

@if (isGameInWritingPhase()) {
    <div class="location-layout">
        <div class="location-panel">
          <location [gameCode]="gameCode"></location>
        </div>
      
        <div class="card-column">
            <mat-card class="instructions" appearance="outlined">
                <write-prompt [gameCode]="gameCode" [gameState]="gameState"></write-prompt>
            </mat-card>
            <mat-card class="game-session-display">
                {{gameSessionDisplay.mapDescription}}
            </mat-card>
        </div>
    </div>
    
    <app-timer 
        [duration]="getTimerDuration()" 
        [label]="'Writing Phase'"
        [autoStart]="false"
        [manualStart]="activePlayerSession.startTimer"
        (timerComplete)="onTimerComplete()">
    </app-timer>
}

@if (isGameInAdventurePhase()) {
    <div class="location-layout">
        <div class="location-panel">
            <div class="map">
            @if (activePlayerSession.story !== null 
                && activePlayerSession.location !== null 
                && activePlayerSession.location.iconDirectory) {
                  <img [src]="activePlayerSession.location.iconDirectory" alt="{{ currentLocation.label }}" class="pyre" />
            }
            </div>
        </div>

        <div class="card-column">
            <adventure [gameCode]="gameCode" [gameState]="gameState" [activePlayerSession]="activePlayerSession" [gameSessionDisplay]="gameSessionDisplay"></adventure>
        </div>
    </div>
}

@if (isGameInRitualPhase()) {
    <div class="location-layout">
        <div class="location-panel">
            <div class="map">
                <img src="assets/images/pyre.gif" alt="Pyre" class="pyre">
            </div>
        </div>

        <div class="card-column">
            <adventure [gameCode]="gameCode" [gameState]="gameState" [activePlayerSession]="activePlayerSession" [gameSessionDisplay]="gameSessionDisplay"></adventure>
            @if(activePlayerSession.outcomeDisplay.length === 0) {
                <mat-card class="game-session-display">
                    {{gameSessionDisplay.goalDescription}} {{gameSessionDisplay.endingDescription}}
                </mat-card>
            }
        </div>
    </div>
}

@if (isGameInWriteEndingTextPhase()) {
    <app-collaborative-text 
        [gameCode]="gameCode" 
        [gameState]="gameState"
        [phaseInfo]="collaborativeTextPhaseInfo"
        [gameBoard]="gameBoard"
        (winningSubmissionLoaded)="loadCollaborativeTextPhaseInfo()">
    </app-collaborative-text>
    
    <app-timer 
        [duration]="getTimerDuration()" 
        [label]="'Ending Text Writing'"
        [autoStart]="false"
        [manualStart]="activePlayerSession.startTimer"
        (timerComplete)="onTimerComplete()">
    </app-timer>
}

@if (isGameInWriteEndingsPhase()) {
    <div class="location-layout">
        <div class="location-panel">
            <div class="map">
                @if (winState.outcomeImage) {
                    <img [src]="winState.outcomeImage" alt="Outcome" class="pyre">
                } @else {
                    <img src="assets/images/pyre.gif" alt="Pyre" class="pyre">
                }
            </div>
        </div>
        <div class="card-column">
            <mat-card class="game-session-display">
                @if (winState.outcomeText) {
                    {{winState.outcomeText}}<br><br>
                }
            </mat-card>
            <mat-card class="instructions" appearance="outlined">
                <div>The die has been cast. Now is the time to decide each other's legacies. Look to your phone to choose what story or ending represents the legacy of another player. Then write their legacy.</div>
            </mat-card>

        </div>

        <app-timer 
            [duration]="getTimerDuration()" 
            [label]="'Epilogue Text Writing'"
            [autoStart]="false"
            [manualStart]="activePlayerSession.startTimer"
            (timerComplete)="onTimerComplete()">
        </app-timer>
    </div>
}

@if (isGameInEndingPhase()) {
    <div class="location-layout">
        <div class="location-panel">
          <location [gameCode]="gameCode"></location>
        </div>
        <div class="card-column">
            <adventure [gameCode]="gameCode" [gameState]="gameState" [activePlayerSession]="activePlayerSession"></adventure>
        </div>
    </div>
}

@if (isGameInFinalePhase()){
    <finale [gameCode]="gameCode" (gameSessionCreated)="setNewGame($event)"></finale>
}

<app-player-progress 
    [gameCode]="gameCode" 
    [activeGameStateSession]="activeGameStateSession">
</app-player-progress>